name: MiTV_Cloud_Engine_v3

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

jobs:
  run-stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-pip
          pip3 install requests

      - name: MiTV Core Streaming Engine
        env:
          FB_URL: "https://ramadan-2385b-default-rtdb.firebaseio.com"
        run: |
          cat << 'EOF' > engine.py
          import requests
          import time
          import os
          import subprocess
          import json

          DATABASE_URL = os.getenv('FB_URL')

          def get_config():
              try:
                  r = requests.get(f"{DATABASE_URL}/streaming_control.json")
                  return r.json()
              except:
                  return None

          def update_heartbeat():
              try:
                  requests.put(f"{DATABASE_URL}/engine_status.json", 
                               json={"last_seen": int(time.time() * 1000)})
              except:
                  pass

          last_command_id = ""

          while True:
              print("Checking for updates from MiTV Admin...")
              config = get_config()
              update_heartbeat()

              if config and config.get('stream_url') and config.get('stream_key'):
                  curr_id = str(config.get('command_id'))
                  
                  if curr_id != last_command_id:
                      print(f"New Configuration Detected! Starting Stream...")
                      last_command_id = curr_id
                      
                      # Settings extract karein
                      url = config['stream_url']
                      key = config['stream_key']
                      logo = config.get('logo_url', 'https://i.ibb.co/fzsgPwYG/2-1.png')
                      text = config.get('scroll_text', 'MiTV Network - Quality Service')
                      color = config.get('text_color', 'white').replace('#', '0x')

                      # FFmpeg Complex Filter Logic (Logo + Scrolling Text)
                      # [0:v] input stream
                      # [1:v] logo
                      # drawtext niche marquee banata hai
                      
                      ffmpeg_cmd = [
                          "ffmpeg", "-re", "-reconnect", "1", "-reconnect_at_eof", "1",
                          "-reconnect_streamed", "1", "-reconnect_delay_max", "5",
                          "-stream_loop", "-1",
                          "-i", url,
                          "-i", logo,
                          "-filter_complex", 
                          f"[1:v]scale=150:-1[l];" \
                          f"[0:v][l]overlay=10:10[bg];" \
                          f"[bg]drawtext=text='{text}':x=w-mod(t*100\,w+tw):y=h-50:fontsize=32:fontcolor={color}:box=1:boxcolor=black@0.5:boxborderw=10[v]",
                          "-map", "[v]", "-map", "0:a",
                          "-c:v", "libx264", "-preset", "ultrafast", "-b:v", "2500k",
                          "-maxrate", "3000k", "-bufsize", "6000k", "-pix_fmt", "yuv420p",
                          "-g", "60", "-c:a", "aac", "-b:a", "128k", "-ar", "44100",
                          "-f", "flv", f"rtmp://a.rtmp.youtube.com/live2/{key}"
                      ]

                      # Purana FFmpeg kill karke naya chalayein agar tabdeeli ho
                      subprocess.Popen(["pkill", "-9", "ffmpeg"])
                      time.sleep(2)
                      process = subprocess.Popen(ffmpeg_cmd)
                      print("Stream is Live!")

              time.sleep(30) # Har 30 sec baad Firebase check karein

          EOF
          python3 engine.py
