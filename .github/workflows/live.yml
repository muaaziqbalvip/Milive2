name: MiTV_Cloud_Engine_v3

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

jobs:
  run-stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-pip
          pip3 install requests

      - name: MiTV Core Streaming Engine (Deep Detection)
        env:
          FB_URL: "https://ramadan-2385b-default-rtdb.firebaseio.com"
        run: |
          cat << 'EOF' > engine.py
          import requests
          import time
          import os
          import subprocess
          import json

          DATABASE_URL = os.getenv('FB_URL')

          def get_config():
              try:
                  r = requests.get(f"{DATABASE_URL}/streaming_control.json")
                  return r.json()
              except:
                  return None

          def update_heartbeat():
              try:
                  requests.put(f"{DATABASE_URL}/engine_status.json", 
                               json={"last_seen": int(time.time() * 1000)})
              except:
                  pass

          last_command_id = ""
          process = None

          while True:
              config = get_config()
              update_heartbeat()

              if config and config.get('stream_url') and config.get('stream_key'):
                  curr_id = str(config.get('command_id'))
                  
                  # Agar naya link aaya ya purana process band ho gaya
                  if curr_id != last_command_id or (process and process.poll() is not None):
                      print(f"Update Detected or Stream Stopped. Initializing...")
                      last_command_id = curr_id
                      
                      url = config['stream_url']
                      key = config['stream_key']
                      logo = config.get('logo_url', 'https://i.ibb.co/fzsgPwYG/2-1.png')
                      text = config.get('scroll_text', 'MiTV Network Live')
                      color = config.get('text_color', 'white').replace('#', '0x')

                      # FFmpeg Command with Bitrate Fix & Deep Probing
                      ffmpeg_cmd = [
                          "ffmpeg", "-hide_banner", "-loglevel", "info",
                          "-reconnect", "1", "-reconnect_at_eof", "1", "-reconnect_streamed", "1", "-reconnect_delay_max", "2",
                          "-probesize", "10M", "-analyzeduration", "10M",
                          "-user_agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                          "-i", url,
                          "-i", logo,
                          "-filter_complex", 
                          f"[1:v]scale=180:-1[logo_scaled];" \
                          f"[0:v]drawbox=y=ih-60:h=60:w=iw:color=black@0.6:t=fill[bg_bar];" \
                          f"[bg_bar][logo_scaled]overlay=10:10[with_logo];" \
                          f"[with_logo]drawtext=text='{text}':x=w-mod(t*120\,w+tw):y=h-45:fontsize=35:fontcolor={color}:fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf[v]",
                          "-map", "[v]", "-map", "0:a?",
                          "-c:v", "libx264", "-preset", "ultrafast", "-b:v", "2500k", "-maxrate", "3000k", "-bufsize", "6000k",
                          "-pix_fmt yuv420p", "-g", "60", "-c:a", "aac", "-b:a", "128k", "-ar", "44100",
                          "-f", "flv", f"rtmp://a.rtmp.youtube.com/live2/{key}"
                      ]

                      if process:
                          process.terminate()
                          time.sleep(2)
                      
                      process = subprocess.Popen(ffmpeg_cmd)
                      print("Streaming Started - Monitoring Bitrate...")

              time.sleep(15) # Check Firebase every 15 seconds

          EOF
          python3 engine.py
