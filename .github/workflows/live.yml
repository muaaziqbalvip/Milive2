name: MiTV_Final_Pro_Engine

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct MP4 Video Link'
        required: true
      audio_url:
        description: 'Direct Audio Link'
        required: true
      stream_key:
        description: 'YouTube Stream Key'
        required: true

jobs:
  run-stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install System Fonts & Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-pip fonts-noto-color-emoji fonts-noto-cjk fonts-nafees
          pip3 install requests pytz

      - name: Start MiTV Professional Engine
        env:
          FB_URL: "https://ramadan-2385b-default-rtdb.firebaseio.com"
          VIDEO: "${{ github.event.inputs.video_url }}"
          AUDIO: "${{ github.event.inputs.audio_url }}"
          KEY: "${{ github.event.inputs.stream_key }}"
        run: |
          cat << 'EOF' > engine.py
          import requests
          import time
          import os
          import subprocess

          VIDEO_IN = os.getenv('VIDEO')
          AUDIO_IN = os.getenv('AUDIO')
          STREAM_KEY = os.getenv('KEY')
          DATABASE_URL = os.getenv('FB_URL')
          LOGO = "https://i.ibb.co/fzsgPwYG/2-1.png"

          last_cmd_id = ""
          process = None

          def get_firebase_data():
              try:
                  r = requests.get(f"{DATABASE_URL}/streaming_control.json", timeout=10)
                  return r.json()
              except: return None

          while True:
              data = get_firebase_data()
              if data:
                  txt = data.get('scroll_text', 'MiTV Network Live')
                  # Escape single quotes for FFmpeg
                  txt = txt.replace("'", "")
                  cmd_id = str(data.get('command_id', '0'))

                  if cmd_id != last_cmd_id or (process and process.poll() is not None):
                      last_cmd_id = cmd_id
                      if process: 
                          process.terminate()
                          time.sleep(3)
                      
                      # Fixed Complex Filter String
                      f_comp = (
                          " [0:v]scale=1280:720[bg]; "
                          " [2:v]scale=110:-1[logo_small]; "
                          " [bg][logo_small]overlay=25:25[v1]; "
                          " [v1]drawbox=x=25:y=105:w=160:h=45:color=0x3E2723@0.9:t=fill[v2]; "
                          " [v2]drawtext=text='%{localtime\\:%I\\\\\\:%M\\\\\\:%S %p}':x=35:y=118:fontsize=20:fontcolor=white[v3]; "
                          " [v3]drawbox=x=25:y=155:w=160:h=35:color=0x5D4037@0.8:t=fill[v4]; "
                          " [v4]drawtext=text='%{localtime\\:%d %b %Y}':x=40:y=165:fontsize=16:fontcolor=0xD4AF37[v5]; "
                          " [v5]drawbox=y=ih-55:h=55:w=iw:color=0xD4AF37@1:t=fill[patti]; "
                          " [patti]drawtext=text='" + txt + "':x=w-mod(t*100,w+tw):y=h-42:fontsize=32:fontcolor=black:fontfile=/usr/share/fonts/truetype/noto/NotoColorEmoji.ttf[v] "
                      )

                      ffmpeg_cmd = [
                          "ffmpeg", "-re", "-hide_banner",
                          "-stream_loop", "-1", "-i", VIDEO_IN,
                          "-stream_loop", "-1", "-i", AUDIO_IN,
                          "-i", LOGO,
                          "-filter_complex", f_comp,
                          "-map", "[v]", "-map", "1:a",
                          "-c:v", "libx264", "-preset", "ultrafast", "-b:v", "2500k",
                          "-pix_fmt", "yuv420p", "-g", "60", "-c:a", "aac", "-b:a", "128k",
                          "-f", "flv", f"rtmp://a.rtmp.youtube.com/live2/{STREAM_KEY}"
                      ]
                      
                      os.environ['TZ'] = 'Asia/Karachi'
                      process = subprocess.Popen(ffmpeg_cmd)
                      print("Engine Status: MiTV Stream Started with Fixed Logic")

              time.sleep(15)
          EOF
          python3 engine.py
